<h1 align="center">Проектирование базы данных telegram</h1>

## :milky_way: Описание проекта:

В качестве проекта, выбран мессенджер telegram. Главная задача проекта - это спроектировать 
базу данных мессенджера. Создание структуры базы данных оценивается возможностями мессенджера, 
рассматривая структуру визуально, можно предположить как она работает на уровне базы данных,
исходя из проектируется структура базы данных.

**Этапы  проекта:**
1. Написание SQL-кода таблиц;
2. Заполнение БД тестовыми данными;
3. Обработка ошибочно сгенерированных данных;
4. Создание связей между таблицами;
5. Написание запросов на извлечение данных;
6. Создание необходимых триггеров для работы БД.

## :file_folder: Файлы проекта:

### :page_facing_up: [`database_structure.sql`](https://github.com/bimastics/Projects-for-Resume/blob/master/database-design/database_structure.sql)

Файл содержит структур базы данных в виде SQL-кода. Разработано 17 таблиц, которые реализуют основные возможности
мессенджера. В случае реализации дополнительного функцианал, потребуется увеличить структуру БД.

Данный файл, хорошо демонстрирует тему "Проектирования БД".

Данный код реализует:
 * __Регистрацию пользователей в системе, для этого используются таблицы:__
   * users - Таблица пользователей;
   * profiles - Профиль пользователя, используется для хранения основной информации о пользователе.
 * __Возможность добавлять других пользователей в контакты, для этого используются таблицы:__
   * contacts - Таблица связи пользователей (друзья);
   * contacts_statuses - Указывает состояние между двумя пользователями 
   (принял заявку, удалён из контактов...).
 * __Создание групп:__
   * groups - Регистрации групп в системе;
   * groups_users - Таблица свзязи пользователй и групп (участники группы);
   * user_types - Указывает тип пользователя в группе (создатель, администратор, модератор).
 * __Создание каналов:__
   * communities - Регистрацие каналов в системе;
   * communities_users - Таблица свзязи пользователй и каналов (участники канала);
   * posts - Публикация контента в формате "поста" для каналов;
   * views - Сохранение пользователей, которые посмотрели пост;
   * user_types - Тип пользователя в канале (создатель, администратор, модератор).
 * __Загрузка медиафайлов:__
   * media - Сохранение медиафайлов пользователя;
   * media_types - Тип медиафайла (архив, видео, аудио...);
 * __Общение между пользователями:__
   * messages - Хранит текст сообщения и автора;
   * target_types - Указывает кому адрессовано сообщение (пользователю, группа);
   * messages_statuses - Статус сообщения (отправлено, доставлено, прочитано...);
   * messages_users - Устанавливает связь между отправителем и получаетелем.
 
### :page_facing_up: [`telegram_data.sql`](https://github.com/bimastics/Projects-for-Resume/blob/master/database-design/telegram_data.sql)

Файл содержит тестовые данные, которые испольлзуются для проверки работоспособности базы данных.
Генерация данных произовдилась сервисом "http://filldb.info/". 

### :page_facing_up: [`data_processing.sql`](https://github.com/bimastics/Projects-for-Resume/blob/master/database-design/data_processing.sql)
Сервис не может предоставить данные под каждую структуру, именно поэтому, некоторые данные пришлось доработать в 
ручном режиме. Данные без обработки нарущают целостность данных в системе, что не позволять установить некоторые связи
между таблицами, также, это усложняет работу с запросами.

Файл представляет собой набор SQL-команды, которые используются для обработки данных. При обработке используются  CRUD-операции.

### :page_facing_up: [`procedure_messages_users.sql`](https://github.com/bimastics/Projects-for-Resume/blob/master/database-design/procedure_messages_users.sql)

Данный файл является продолжение файла [data_processing.sql](https://github.com/bimastics/Projects-for-Resume/blob/master/database-design/data_processing.sql)

В процессе обработки данных таблицы messages_users, была задача восстановить целостность значений, которые 
ссылаются на несуществующие идентификаторы таблицы. Для решение проблемы, был написан запрос генерации новых идентификаторов, которые удовлетворяют всем требованиям. Так как данный запрос потребовалось бы запустить огромное количество раз, была написана процедура обновления множество строк, одним запуском.

Логика проверки количества необновлённых данных вынесена в функцию. Функция используется для проверки, имеются ли ещё данные, которые необходимо обновить, если да, функция возвращает TRUE, иначе FALSE.

Процедура выполняет обновление записей по циклу, внутри которго встроена команда UPDATE, цикл работает до тех пор, 
пока функция возвращает TRUE, если функция вернула FALSE, тогда все записи считаются обновленными.

Данная проблема стала причиной, по которой, набор этих команд был вынесен в отдельный файл.

### :package: [`Сommunication`](https://github.com/bimastics/Projects-for-Resume/tree/master/database-design/Сommunication)

Внутри данной директории находится логка связей между таблицами.
 * :page_facing_up: **[`foreign_key.sql`](https://github.com/bimastics/Projects-for-Resume/blob/master/database-design/Сommunication/foreign_key.sql)** Внутри файла SQL-код, который реализет связи между таблицами.
* :page_facing_up: **[`EER_Diagram.svg`](https://github.com/bimastics/Projects-for-Resume/blob/master/database-design/Сommunication/EER_Diagram.svg)** ER диаграмма, которая отображает отношения набора сущностей, хранящиеся в базе данных. Сохранена в виде SVG файла, который позволяет визуально оценить структуру БД.
* :page_facing_up: **[`EER_Diagram.mwb`](https://github.com/bimastics/Projects-for-Resume/blob/master/database-design/Сommunication/EER_Diagram.mwb)** Аналогично описанному выше, только данный файл имеет формат, который позволяет загрузить диаграмму в графический интерфейс (MySQL).

### :page_facing_up: [`requests.sql`](https://github.com/bimastics/Projects-for-Resume/blob/master/database-design/requests.sql)

Внутри файла находятся основные запросы, среди которых, JOIN запросы на выборку медиафайлов, сообщений, запросы с использованием оконных функций.

### :page_facing_up: [`trigger_update_and_insert_messages.sql`](https://github.com/bimastics/Projects-for-Resume/blob/master/database-design/trigger_update_and_insert_messages.sql)

В файле реализовано два триггера, первый контроллирует вставку, воторой обновление данных в таблице сообщений между пользователями и группами. Так как связь задаётся неявно (target_id ссылается на идентификатор записи, а target_type_id указывает таблицу или другими словами, указывает кому было отправлено сообщение, пользователю или в группу), обработать такой случай стандартными возможностями MySQL не получится.

Тригер рабаботает аналогично тому, как СУБД проверяет допустимость значений внешнего ключа, 
например для столбца user_id и ссылку на id из таблицы users.
Триггер работает на вставку/обновление строки в таблице messages_users, который проверяет по введённым значениям target_id и target_type_id, существует ли
в соответствующей таблице запись с представленным id. Если в соответствующей таблице, которая задана ссылкой в target_type_id нет идентификатора установленного в столбце target_id, то будет генерироваться ошибка. Ошибка сообщает о том, что не ссылочной целостности (Попытка вставки данных, которых 
нет в связанных на ЛОГИЧЕСКОМ уровне таблицах).
